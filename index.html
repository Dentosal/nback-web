<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moni n-taa</title>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="main.js"></script>
    <script src="stats.js"></script>
    <script src="update.js"></script>
    <link rel="stylesheet" href="style.css">
</head>

<body x-data>
    <dialog id="menu" @keydown="if ($event.key === 'Escape') $event.preventDefault();">
        <div id="menucontent">
            <div id="update" @click="window.location.reload()"></div>
            <div>
                <h2>Moni <i>n</i>-taa</h2>
                <p>Työmuistia kehittävä harjoitus <a href="https://gwern.net/dnb-faq" target="_blank"><i>Gwern</i>in artikkelin suosituksilla.</a></p>
    
                <p>
                    Tämä versio tallentaa kaiken paikallisesti selaimeesi,
                    ja näin ollen kunnioittaa yksityisyyttäsi.
                    <s>Voit halutessasi jakaa tuloksesi alla olevista napeista.</s> (työn alla)
                </p>
                <p>
                    <a href="https://github.com/Dentosal/nback-web/" target="_blank">Lähdekoodi on tarjolla GitHubissa.</a>
                    Viimeisimmät muutokset:
                    <ul>
                        <li>Parannettu reaktiopainikkeita kosketusnäyttölaitteilla</li>
                        <li>Korjattu aktiivisuusvinouma-asetuksen vanhoja arvoja, jotka näkyivät väärinä historiassa</li>
                        <li>Lisätty automaattinen päivitysten tarkastus</li>
                        <li>Korjattu multitouch-tuki ja ulkoasu mobiililaitteilla</li>
                    </ul>
                </p>
            </div>
            <div class="mid">
                <input type="button" value="Historia" @click="document.querySelector('#history').showModal()">
                <!-- <input type="button" value="Tilastot"> -->
                <!-- <input type="button" value="Jaa parhaat tulokset"> -->
            </div>
            <div class="mid large">
                <input type="button" value="Aloita" autofocus ="!$store.state.hasValidSettings" @click="startGame()">
            </div>
        </div>
        <form id="settings" action="javascript:void(0);" @change="updateSettings()" @keydown="updateSettings()">
            <div>
                <h2>Asetukset</h2>
                <input type="button" class="danger" value="Oletukset" @click="writeSettings(defaultSettings); $store.settings = readSettings()">
            </div>
            <div>
                <input type="number" x-model.number="$store.settings.n" id="settings-n" min=1 max=100 step=1>
                <label for="settings-n">kohtaa taaksepäin</label>
            </div>
            <div>
                <input type="number" x-model.number="$store.settings.runLength" id="settings-runLength" :min="parseInt($store.settings.n) + 1" step=1>
                <label for="settings-runLength">kpl sessio</label>
            </div>
            <div>
                <input type="number" x-model.number="$store.settings.secondsPerTrial" id="settings-secondsPerTrial" min=0.5 max=10.0 step=0.1>
                <label for="settings-secondsPerTrial">sekunnin välein</label>
            </div>
            <div>
                <input type="number" x-model.number="$store.settings.actionBias" id="settings-actionBias" min=0.0 max=0.9 step=0.05>
                <label for="settings-actionBias">aktiivisuusvinouma
                    <span data-tooltip="lisätodennäköisyys sille, että ärsyke täsmää n-taa"></span>
                </label>
            </div>
            <div>
                <label><input type="checkbox" x-model.boolean="$store.settings.position.enabled">Sijainti</label>
                <input type="text" :value="$store.settings.position.key" @keydown.prevent="$store.settings.position.key=event.key" class="key"></span>
            </div>
            <div>
                <label><input type="checkbox" x-model.boolean="$store.settings.audio.enabled">Ääni
                <select x-model="$store.settings.audio.set">
                    <template x-for="audio in audios">
                        <option :value="audio" x-text="audio" :selected="audio == $store.settings.audio.set"></option>
                    </template>
                </select>
                </label>
                <input type="text" :value="$store.settings.audio.key" @keydown.prevent="$store.settings.audio.key=event.key" class="key"></span>
            </div>
            <div>
                <label>
                    <input type="checkbox" x-model.boolean="$store.settings.color.enabled">Väri
                    <select x-model="$store.settings.color.set">
                        <template x-for="color of Object.keys(colors)">
                            <option :value="color" x-text="color" :selected="color == $store.settings.color.set"></option>
                        </template>
                    </select>
                </label>
                <input type="text" :value="$store.settings.color.key" @keydown.prevent="$store.settings.color.key=event.key" class="key"></span>
            </div>
            <div>
                <label><input type="checkbox" disabled x-model.boolean="$store.settings.shape.enabled"><s>Muoto</s> (työn alla)</label>
                <!-- <label><input type="checkbox" x-model.boolean="$store.settings.shape.enabled">Muoto</label> -->
                <input type="text" :value="$store.settings.shape.key" @keydown.prevent="$store.settings.shape.key=event.key" class="key"></span>
            </div>
        </div>
    </dialog>

    <template x-if="$store.state.selectedRun !== null && $store.state.selectedRun < $store.runHistory.length">
        <dialog id="runstats">
            <div>
                <h2>Tulokset suoritukselle #<span x-text="$store.state.selectedRun + 1"></span></h2>
                <input type="button" value="Takaisin" @click="backToMenu">
            </div>
            <div>
                <span x-text="$store.runHistory[$store.state.selectedRun].settings.n"></span> kohtaa taaksepäin,
                <span x-text="$store.runHistory[$store.state.selectedRun].settings.runLength"></span> kpl sessio,
                <span x-text="$store.runHistory[$store.state.selectedRun].settings.secondsPerTrial"></span> sekunnin välein
                <span x-text="$store.runHistory[$store.state.selectedRun].settings.actionBias"></span> aktiivisuusvinouma
            </div>
            <div>
                <input type="checkbox" inert :value="$store.settings.position.enabled">Sijainti
                <input type="checkbox" inert :value="$store.settings.audio.enabled">Ääni
                    (<span x-text="$store.runHistory[$store.state.selectedRun].settings.audio.set"></span>)
                    <input type="checkbox" inert :value="$store.settings.color.enabled">Väri
                    (<span x-text="$store.runHistory[$store.state.selectedRun].settings.color.set"></span>)
                <input type="checkbox" inert :value="$store.settings.shape.enabled">Muoto
            </div>
            <div>
                <p>Pisteet: <span x-text="Math.round(runScore($store.runHistory[$store.state.selectedRun])*100) + '%'"></span></p>
            </div>
            <table>
                <thead>
                    <th>Kierros</th>
                    <th x-show="$store.runHistory[$store.state.selectedRun].settings.position.enabled">Sijainti</th>
                    <th x-show="$store.runHistory[$store.state.selectedRun].settings.position.enabled">Reaktio</th>
                    <th x-show="$store.runHistory[$store.state.selectedRun].settings.audio.enabled">Ääni</th>
                    <th x-show="$store.runHistory[$store.state.selectedRun].settings.audio.enabled">Reaktio</th>
                    <th x-show="$store.runHistory[$store.state.selectedRun].settings.color.enabled">Väri</th>
                    <th x-show="$store.runHistory[$store.state.selectedRun].settings.color.enabled">Reaktio</th>
                    <th x-show="$store.runHistory[$store.state.selectedRun].settings.shape.enabled">Muoto</th>
                    <th x-show="$store.runHistory[$store.state.selectedRun].settings.shape.enabled">Reaktio</th>
                </thead>
                <tbody>
                    <template x-for="(entry, i) in $store.runHistory[$store.state.selectedRun].run">
                        <tr>
                            <td x-text="i + 1"></td>
                            <td x-show="$store.runHistory[$store.state.selectedRun].settings.position.enabled"
                                :data-correct="entry.correct.position"
                                :data-incorrect="!entry.correct.position"
                                x-text="entry.position + 1"
                            ></td>
                            <td x-show="$store.runHistory[$store.state.selectedRun].settings.position.enabled"
                                :data-pressed="'position' in entry.response"
                                :data-latency="entry.latency?.position ?? '???'"
                            ></td>
                            <td x-show="$store.runHistory[$store.state.selectedRun].settings.audio.enabled"
                                :data-correct="entry.correct.audio"
                                :data-incorrect="!entry.correct.audio"
                                x-text="entry.audio + 1"
                            ></td>
                            <td x-show="$store.runHistory[$store.state.selectedRun].settings.audio.enabled"
                                :data-pressed="'audio' in entry.response"
                                :data-latency="entry.latency?.audio ?? '???'"
                            ></td>
                            <td x-show="$store.runHistory[$store.state.selectedRun].settings.color.enabled"
                                :data-correct="entry.correct.color"
                                :data-incorrect="!entry.correct.color"
                                :style="{backgroundColor: colors[$store.runHistory[$store.state.selectedRun].settings.color.set][entry.color]}"
                                class="outline"
                                x-text="entry.color + 1"
                            ></td>
                            <td x-show="$store.runHistory[$store.state.selectedRun].settings.color.enabled"
                                :data-pressed="'color' in entry.response"
                                :data-latency="entry.latency?.color ?? '???'"
                            ></td>
                            <td x-show="$store.runHistory[$store.state.selectedRun].settings.shape.enabled"
                                :data-correct="entry.correct.shape"
                                :data-incorrect="!entry.correct.shape"
                                x-text="entry.shape"
                            ></td>
                            <td x-show="$store.runHistory[$store.state.selectedRun].settings.shape.enabled"
                                :data-pressed="'shape' in entry.response"
                                :data-latency="entry.latency?.shape ?? '???'"
                            ></td>
                        </tr>
                    </template>
                    <tr>
                        <td>Tulos</td>
                        <td
                            x-show="$store.runHistory[$store.state.selectedRun].settings.position.enabled"
                            x-text="columnScoreStr($store.runHistory[$store.state.selectedRun], 'position')"
                        ></td>
                        <td
                            x-show="$store.runHistory[$store.state.selectedRun].settings.position.enabled"
                            x-text="columnLatencyAvgStr($store.runHistory[$store.state.selectedRun], 'position')"
                        ></td>

                        <td
                            x-show="$store.runHistory[$store.state.selectedRun].settings.audio.enabled"
                            x-text="columnScoreStr($store.runHistory[$store.state.selectedRun], 'audio')"
                        ></td>
                        <td
                            x-show="$store.runHistory[$store.state.selectedRun].settings.audio.enabled"
                            x-text="columnLatencyAvgStr($store.runHistory[$store.state.selectedRun], 'audio')"
                        ></td>

                        <td
                            x-show="$store.runHistory[$store.state.selectedRun].settings.color.enabled"
                            x-text="columnScoreStr($store.runHistory[$store.state.selectedRun], 'color')"
                        ></td>
                        <td
                            x-show="$store.runHistory[$store.state.selectedRun].settings.color.enabled"
                            x-text="columnLatencyAvgStr($store.runHistory[$store.state.selectedRun], 'color')"
                        ></td>

                        <td
                            x-show="$store.runHistory[$store.state.selectedRun].settings.shape.enabled"
                            x-text="columnScoreStr($store.runHistory[$store.state.selectedRun], 'shape')"
                        ></td>
                        <td
                            x-show="$store.runHistory[$store.state.selectedRun].settings.shape.enabled"
                            x-text="columnLatencyAvgStr($store.runHistory[$store.state.selectedRun], 'shape')"
                        ></td>
                    </tr>
                </tbody>
            </table>
        </dialog>
    </template>

    <dialog id="history">
        <div>
            <h2>Historia</h2>
            <input type="button" value="Takaisin" @click="backToMenu">
        </div>
        <div>
            Pelattu yhteensä <span x-text="formatTime(totalTime($store.runHistory))"></span>, josta
            <span x-text="formatTime(totalTimeToday($store.runHistory))"></span> tänään.
        </div>
        <table>
            <thead>
                <th>nro</th>
                <th>milloin päättyi</th>
                <th>tyyli</th>
                <th>n</th>
                <th>kpl</th>
                <th>viive</th>
                <th>bias</th>
                <th>tulos</th>
                <th>avaa</th>
            </thead>
            <tbody>
                <template x-for="(run, i) in $store.runHistory" :key="i">
                    <tr>
                        <td x-text="i + 1"></td>
                        <td x-text="new Date(run.endMoment).toLocaleString('fi-FI')"></td>
                        <td>
                            <span x-show="run.settings.position.enabled">S</span>
                            <span x-show="run.settings.audio.enabled">Ä</span>
                            <span x-show="run.settings.color.enabled">V</span>
                            <span x-show="run.settings.shape.enabled">M</span>
                        </td>
                        <td x-text="run.settings.n"></td>
                        <td x-text="run.settings.runLength"></td>
                        <td x-text="run.settings.secondsPerTrial + 's'"></td>
                        <td x-text="run.settings.actionBias"></td>
                        <td x-text="Math.round(runScore(run)*100) + '%'"></td>
                        <td>
                            <input type="button" value="Avaa"
                                @click="$store.state.selectedRun = i; setTimeout(() => document.querySelector('#runstats').showModal(), 0)"
                            >
                        </td>
                    </tr>
                </template>
            </tbody>
        </table>
    </dialog>

    <div id="game">
        <div id="topmenu">
            <div>
                <span x-text="$store.state.currentRun.length"></span>/<span x-text="$store.settings.runLength"></span>
            </div>
            <input type="button" value="Keskeytä" @click="window.location.reload()">
        </div>
        <div id="gamegrid">
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
        </div>
        <div id="responses">
            <div class="position" x-show="$store.settings.position.enabled"
                :class="{ pending: $store.state.currentRun.length > 0 && $store.state.currentRun.at(-1).response.position }"
                @click="sendResponse('position')" @touchstart="sendResponse('position')">
                Sijainti <span x-text="$store.settings.position.key"></span>
            </div>
            <div class="audio" x-show="$store.settings.audio.enabled"
                :class="{ pending: $store.state.currentRun.length > 0 && $store.state.currentRun.at(-1).response.audio }"
                @click="sendResponse('audio')" @touchstart="sendResponse('audio')">
                Ääni <span x-text="$store.settings.audio.key"></span>
            </div>
            <div class="color" x-show="$store.settings.color.enabled"
                :class="{ pending: $store.state.currentRun.length > 0 && $store.state.currentRun.at(-1).response.color }"
                @click="sendResponse('color')" @touchstart="sendResponse('color')">
                Väri <span x-text="$store.settings.color.key"></span>
            </div>
            <div class="shape" x-show="$store.settings.shape.enabled"
                :class="{ pending: $store.state.currentRun.length > 0 && $store.state.currentRun.at(-1).response.shape }"
                @click="sendResponse('shape')" @touchstart="sendResponse('shape')">
                Muoto <span x-text="$store.settings.shape.key"></span>
            </div>
        </div>
    </div>
</body>
</html>